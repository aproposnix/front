language: node_js
node_js:
  - "10"

cache: yarn

# Define environment variables
env:
  - secure: "WqD+4pU4XjQJzkGt2D0RouTEn4l+fgxmE0VehCw1IzdUrjpCoqQRk6C/z3Ubu8m26cX7vPEDoHQxsmHFOgKKAbkwWCuDtA9P7puSTydjiRaAl+4d9k+p21dp75kq/VEPTdySZiCs9SZuhJQZ64ao5pJXiqTQ/JfU/34MqWXjc0k2n+eNmGK9SpgX//fw/U/KU0yItujEYTzfc1MvpUBHaGjLehcavIXfGDo+Tx81wRWq2crtebZm2pDrasf7xdyHrpsmJzbrxsmNdF5FJnlpgzxwPGkq231G26MarWhmVhARkA0OqxyJIDu1LUeDMbyT17UFOddiFeI1zRsZMTUdTO9ZD0BeKygXtn+8VC2SPDbL89/kZZgHTGa79zjKvKrwSumCKeBc+AITmVKqOTyJrwQKAy0I0CslUyWTPOfASwXxBSpydReVA6OnoD72vv45DEV6g9Mf1j8OnWO5ETiRRhq2BzOo4BsQot8phcI5kAav1chQUZ8BktYd2drDPMJbkzWBaslIiCWQtpP+hjCmgS20Eb7YiQoetlNjbu4isK5JjuYYC58vPyfMXgVsVQNmOGG33o7nT0EVVef7Ma85eskj0U4xI0HGGogNqScRo7595w7TgcYiZUuCWn0puyQKIXUUp1EWSaNzj803EbIaZskRb7lbveRoMr9l1e+q0D4M="

install:
  - yarn global add @angular/cli
  - yarn install
  - ./get-info.sh

jobs:
    include:
        - stage: test
          script: yarn run lint && yarn run build -- --prod --stats-json
          fast_finish: true
        - stage: deploy
          if: branch = dev AND NOT type = "pull_request"
          before_install:
              - sudo apt-get install python3-pip python3-setuptools
              - pip3 install awscli --upgrade
          script: ./build-deploy.sh testing
        - stage: deploy
          if: branch =~ /^release\/.*$/ AND NOT type = "pull_request"
          before_install:
              - sudo apt-get install python3-pip python3-setuptools
              - pip3 install awscli --upgrade
          script: ./build-deploy.sh stage
        - stage: deploy
          if: (NOT branch = master) AND tag IS present
          before_install:
              - sudo apt-get install python3-pip python3-setuptools
              - pip3 install awscli --upgrade
          script: ./build-deploy.sh develop
        - stage: deploy
          if: branch = master AND NOT type = "pull_request" AND tag IS present AND tag =~ /^v.*$/
          before_install:
              - sudo apt-get install python3-pip python3-setuptools
              - pip3 install awscli --upgrade
          script: ./build-deploy.sh front && ./build-deploy.sh demo
